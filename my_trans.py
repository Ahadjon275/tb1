#!/usr/bin/env python3


from py_trans import PyTranslator
from langdetect import detect, detect_langs
import subprocess
import gpt_basic
import re
import enchant


def count_russian_words_not_in_ukrainian_dict(text):
    """–°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä—É—Å—Å–∫–∏—Ö —Å–ª–æ–≤ –≤ —Ç–µ–∫—Å—Ç–µ, —ç—Ç–∏ —Å–ª–æ–≤–∞ –Ω–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ —É–∫—Ä–∞–∏–Ω—Å–∫–æ–º"""
    d_ru = enchant.Dict("ru_RU")
    d_uk = enchant.Dict("uk_UA")
    russian_words = []
    # –ó–∞–º–µ–Ω—è–µ–º –≤—Å–µ —Å–∏–º–≤–æ–ª—ã, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –∞–ª—Ñ–∞–≤–∏—Ç–∞—Ö, –Ω–∞ –ø—Ä–æ–±–µ–ª—ã
    text = re.sub(r"[^–∞-—è–ê-–Ø—ñ–Ü—ó–á—î–Ñ—ë–Å]+", " ", text)
    for word in text.split():
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–ª–æ–≤–æ —Ä—É—Å—Å–∫–∏–º
        if d_ru.check(word) and not d_uk.check(word):
            russian_words.append(word)
    return len(russian_words)


def count_ukr_words(text):
    """–°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–∫—Ä–∞–∏–Ω—Å–∫–∏—Ö —Å–ª–æ–≤ –Ω–µ –ø–µ—Ä–µ—Å–µ–∫–∞—é—â–∏—Ö—Å—è —Å —Ä—É—Å—Å–∫–∏–º–∏"""
    d_uk = enchant.Dict("uk_UA")
    d_ru = enchant.Dict("ru_RU")
    words = []
    # –ó–∞–º–µ–Ω—è–µ–º –≤—Å–µ —Å–∏–º–≤–æ–ª—ã, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –∞–ª—Ñ–∞–≤–∏—Ç–∞—Ö, –Ω–∞ –ø—Ä–æ–±–µ–ª—ã
    text = re.sub(r"[^–∞-—è–ê-–Ø—ñ–Ü—ó–á—î–Ñ—ë–Å]+", " ", text)
    for word in text.split():
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–ª–æ–≤–æ —Ä—É—Å—Å–∫–∏–º
        if d_uk.check(word) and not d_ru.check(word):
            words.append(word)
    return len(words)


def detect_lang(text):
    """ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç None –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, 2 –±—É–∫–≤–µ–Ω–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —è–∑—ã–∫–∞ –µ—Å–ª–∏ –ø–æ–ª—É—á–∏–ª–æ—Å—å 'en', 'ru' –∏—Ç–ø """
    # –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª–æ–≤ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —è–∑—ã–∫–∞ = 8. –Ω–∞ –∫–æ—Ä–æ—Ç–∫–∏—Ö —Ç–µ–∫—Å—Ç–∞—Ö –¥–µ—Ç–µ–∫—Ç–æ—Ä —Å–∏–ª—å–Ω–æ –≤—Ä—ë—Ç, –≤–æ–∑–º–æ–∂–Ω–æ 8 —ç—Ç–æ —Ç–æ–∂–µ –º–∞–ª–æ
    if sum(1 for word in text.split() if len(word) >= 2) < 8:
        return None
    
    # –µ—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ –±–æ–ª—å—à–µ 2 —Ä—É—Å—Å–∫–∏—Ö —Å–ª–æ–≤ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º None
    if count_russian_words_not_in_ukrainian_dict(text) > 2:
        return None

    # –µ—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ –±–æ–ª—å—à–µ 2 —á–∏—Å—Ç–æ —É–∫—Ä–∞–∏–Ω—Å–∫–∏—Ö —Å–ª–æ–≤ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º 'uk'
    if count_ukr_words(text) > 2:
        return 'uk'

    # —Å–º–æ—Ç—Ä–∏–º —Å–ø–∏—Å–æ–∫ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π, –∏ –µ—Å–ª–∏ –≤ —Å–ø–∏—Å–∫–µ –µ—Å—Ç—å —Ä—É—Å—Å–∫–∏–π —Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º None (—Å —Ä—É—Å—Å–∫–æ–≥–æ –Ω–∞ —Ä—É—Å—Å–∫–∏–π –Ω–µ –ø–µ—Ä–µ–≤–æ–¥–∏–º)
    print(detect_langs(text))
    try:
        for i in detect_langs(text):
            if i.lang == 'ru':
                return None
    except Exception as e:
        print(e)
        return None

    try:
        language = detect(text)
    except Exception as e:
        print(e)
        return None
    return language


def translate_text(text, lang = 'ru'):
    """ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç None –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –∏ —Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–≤–æ–¥–∞ –µ—Å–ª–∏ —É–¥–∞–ª–æ—Å—å """
    x = PyTranslator()
    r = x.translate(text, lang)
    if r['status'] == 'success':
        return r['translation']
    return None
    

def translate_text2(text, lang = 'ru'):
    """ –ü–µ—Ä–µ–≤–æ–¥–∏—Ç text –Ω–∞ —è–∑—ã–∫ lang —Å –ø–æ–º–æ—â—å—é —É—Ç–∏–ª–∏—Ç—ã trans. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç None –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –∏ —Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–≤–æ–¥–∞ –µ—Å–ª–∏ —É–¥–∞–ª–æ—Å—å """
    process = subprocess.Popen(['trans', f':{lang}', '-b', text], stdout = subprocess.PIPE)
    output, error = process.communicate()
    r = output.decode('utf-8').strip()
    if error != None:
        return None
    return r


def translate(text):
    """ –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–¥–æ –ª–∏ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–∏–π –∏ –ø–µ—Ä–µ–≤–æ–¥–∏–º –µ—Å–ª–∏ –Ω–∞–¥–æ.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç None –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –∏ —Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–≤–æ–¥–∞ –µ—Å–ª–∏ —É–¥–∞–ª–æ—Å—å """
    if text:
        d = detect_lang(text)
    else:
        return None
    # –ø–µ—Ä–µ–≤–æ–¥–∏–º –µ—Å–ª–∏ —è–∑—ã–∫ –Ω–µ —Ä—É—Å—Å–∫–∏–π –Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏–ª—Å—è —É—Å–ø–µ—à–Ω–æ
    if d and d != 'ru':
        # —ç—Ç–æ—Ç –≤–∞—Ä–∏–∞–Ω—Ç –ø–æ—á–µ–º—É —Ç–æ –∑–∞–º–µ—Ç–Ω–æ —Ö—É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, —Ö–æ—Ç—è –≤—Ä–æ–¥–µ –±—ã —Ç–æ—Ç –∂–µ —Å–∞–º—ã–π –≥—É–≥–ª –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫
        #return translate_text(text)

        #—É —ç—Ç–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å –∫–æ–¥–∏—Ä–æ–≤–∫–∞–º–∏ –≤ –¥–æ–∫–µ—Ä–µ –ñ)
        #return translate_text2(text)
        
        #return gpt_basic.translate_text(text) or translate_text2(text) or None
        # –æ—Ç–∫–ª—é—á–∏–ª –ì–ü–¢, –æ–Ω —á–∞—Å—Ç–æ –≤–∫–ª—é—á–∞–µ—Ç —Ü–µ–Ω–∑—É—Ä—É
        return translate_text2(text) or None
    return None
    

if __name__ == "__main__":
    #text="""–ó–≤–∏—á–∞–π–Ω–æ, —è –º–æ–∂—É –Ω–∞–ø–∏—Å–∞—Ç–∏ –¥–≤–∞ —Ä–µ—á–µ–Ω–Ω—è –Ω–∞ —É–∫—Ä–∞—ó–Ω—Å—å–∫—ñ–π –º–æ–≤—ñ."""
    
    
    text = """–ö–æ–ª–∏ —É –Ω–∞—Å –±—É–¥—É—Ç—å F-16, –º–∏ –≤–∏–≥—Ä–∞—î–º–æ —Ü—é –≤—ñ–π–Ω—É, - –Ü–≥–Ω–∞—Ç

F-16 ‚Äì –±–∞–≥–∞—Ç–æ—Ü—ñ–ª—å–æ–≤–∏–π –ª—ñ—Ç–∞–∫, —è–∫–∏–π –º–æ–∂–µ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –ø–æ –Ω–∞–∑–µ–º–Ω–∏—Ö, –ø–æ–≤—ñ—Ç—Ä—è–Ω–∏—Ö —Ç–∞ –Ω–∞–¥–≤–æ–¥–Ω–∏—Ö —Ü—ñ–ª—è—Ö, –∞ —Ç–∞–∫–æ–∂ –±—É–¥–µ –ø–µ—Ä–µ–∫—Ä–∏–≤–∞—Ç–∏ –Ω–∞—à—É —Ç–µ—Ä–∏—Ç–æ—Ä—ñ—é —Ç–∞–º, –¥–µ –Ω–µ–º–∞—î –∫–æ–º–ø–ª–µ–∫—Å—ñ–≤ –ü–ü–û.

"–Ø –≤–∞–º —Å–∫–∞–∂—É –±—ñ–ª—å—à–µ, –∫–æ–ª–∏ –±—É–¥—É—Ç—å F-16, –º–∏ –≤–∏–≥—Ä–∞—î–º–æ —Ü—é –≤—ñ–π–Ω—É. –Ø–∫—â–æ —Ü—ñ –ª—ñ—Ç–∞–∫–∏ –ø—Ä–∏–π–¥—É—Ç—å –≤ –£–∫—Ä–∞—ó–Ω—É, –≤–æ–Ω–∏ —Å—Ç–∞–Ω—É—Ç—å –Ω–∞ –±–æ–π–æ–≤–µ —á–µ—Ä–≥—É–≤–∞–Ω–Ω—è —É —Ä—ñ–∑–Ω–∏—Ö —Ä–µ–≥—ñ–æ–Ω–∞—Ö –Ω–∞ –Ω–∞—à–∏—Ö –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–∏—Ö –∞–µ—Ä–æ–¥—Ä–æ–º–∞—Ö", ‚Äî –∑–∞—É–≤–∞–∂–∏–≤ –Ü–≥–Ω–∞—Ç.

–¢–µ—Ä–∏—Ç–æ—Ä—ñ—è –∫—Ä–∞—ó–Ω–∏ —Ç–∞ –ø—Ä–æ—Ç—è–∂–Ω—ñ—Å—Ç—å –¥–µ—Ä–∂–∞–≤–Ω–æ–≥–æ –∫–æ—Ä–¥–æ–Ω—É –≤–µ–ª–∏–∫–∞, –∞ –ª—ñ–Ω—ñ—è —Ñ—Ä–æ–Ω—Ç—É, –≤—Ä–∞—Ö–æ–≤—É—é—á–∏ –ë—ñ–ª–æ—Ä—É—Å—å, –ü—Ä–∏–¥–Ω—ñ—Å—Ç—Ä–æ–≤'—è —Ç–∞ —á–æ—Ä–Ω–æ–º–æ—Ä—Å—å–∫–µ —É–∑–±–µ—Ä–µ–∂–∂—è - –ø–æ–Ω–∞–¥ 2,5 —Ç–∏—Å. –∫–º —ñ –ø–µ—Ä–µ–∫—Ä–∏—Ç–∏ –∫–æ–º–ø–ª–µ–∫—Å–∞–º–∏ –ü–ü–û, –≤—Å–µ –Ω–µ –≤–¥–∞—Å—Ç—å—Å—è, —Å–∞–º–µ —Ç–æ–º—É –Ω–∞–º —Ç—Ä–µ–±–∞ F-16.

–¶–µ–π –≤–∏–Ω–∏—â—É–≤–∞—á –º–æ–∂–µ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –ø–æ –ø–æ–≤—ñ—Ç—Ä—è–Ω–∏—Ö —Ü—ñ–ª—è—Ö —è–∫ –∑–Ω–∏–∑—É, —Ç–∞–∫ —ñ –∑–≤–µ—Ä—Ö—É. –¢–∞–º, –¥–µ –Ω–µ–º–∞—î –ü–ü–û, –±—É–¥–µ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ F-16.

–Ω–∞–¥i—Å–ª–∞—Ç–∏ –Ω–æ–≤–∏–Ω—É @novosti_kieva_bot
üëâ–ü–Ü–î–ü–ò–°–ê–¢–ò–°–¨ (https://t.me/+YjYxxNba5fYyN2Ni)"""
    
    #print(translate_text2(text, 'en'))
    
    #print(translate_text(text))
    #print(translate_text2(text))

    #print(translate(text))

    print(detect_lang('—ñ—Å—Ç–æ—Ä—ñ—î—é —Ç–∞ –∫—É–ª—å—Ç—É—Ä–æ—é. –¢–æ–ª—å–∫–æ –Ω–µ –≥–æ–≤–æ—Ä–∏ —á—Ç–æ –Ω–∞–¥–æ'))
